<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InsuranceCo. Claim Fraud Detection Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .header .badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }

        .stat-card .label {
            color: #888;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .subtext {
            color: #666;
            font-size: 0.9em;
        }

        .stat-card.high-risk .value {
            color: #e74c3c;
        }

        .stat-card.medium-risk .value {
            color: #f39c12;
        }

        .stat-card.low-risk .value {
            color: #27ae60;
        }

        .stat-card.total .value {
            color: #667eea;
        }

        .chart-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .chart-card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .actions-panel {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .actions-panel h3 {
            color: #333;
            margin-bottom: 20px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-info {
            background: #3498db;
            color: white;
        }

        .btn-info:hover {
            background: #2980b9;
        }

        .claim-form {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
        }

        .claim-form.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .results-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .result-card {
            border-left: 5px solid #667eea;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .result-card.high-risk {
            border-left-color: #e74c3c;
            background: #fee;
        }

        .result-card.medium-risk {
            border-left-color: #f39c12;
            background: #fef5e7;
        }

        .result-card.low-risk {
            border-left-color: #27ae60;
            background: #eafaf1;
        }

        .risk-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .risk-badge.high {
            background: #e74c3c;
            color: white;
        }

        .risk-badge.medium {
            background: #f39c12;
            color: white;
        }

        .risk-badge.low {
            background: #27ae60;
            color: white;
        }

        .risk-badge.critical {
            background: #c0392b;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .indicator-list {
            list-style: none;
            padding: 0;
            margin-top: 15px;
        }

        .indicator-list li {
            padding: 8px;
            margin-bottom: 5px;
            background: white;
            border-radius: 5px;
            border-left: 3px solid #e74c3c;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: none;
            z-index: 1000;
        }

        .toast.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
            }
            to {
                transform: translateX(0);
            }
        }

        .high-risk-claims {
            margin-top: 20px;
        }

        .high-risk-claim-item {
            background: #fee;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
            margin-bottom: 10px;
        }

        /* Activity Log Styles */
        .activity-log {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin: 20px 0;
            max-height: 500px;
            display: none;
            flex-direction: column;
        }

        .activity-log.active {
            display: flex;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .log-header h3 {
            margin: 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .log-controls {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 5px 12px;
            font-size: 0.9em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #667eea;
            color: white;
            transition: all 0.3s;
        }

        .btn-small:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .progress-bar-container {
            width: 100%;
            margin: 10px 0;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9em;
            font-weight: bold;
        }

        .log-content {
            flex: 1;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            max-height: 300px;
        }

        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry.info {
            color: #17a2b8;
        }

        .log-entry.success {
            color: #28a745;
            font-weight: 500;
        }

        .log-entry.warning {
            color: #ffc107;
        }

        .log-entry.error {
            color: #dc3545;
            font-weight: 500;
        }

        .log-entry.high-risk {
            color: #dc3545;
            font-weight: bold;
            background: #fff5f5;
            padding: 8px;
            margin: 2px 0;
            border-radius: 5px;
        }

        .log-timestamp {
            color: #6c757d;
            font-size: 0.85em;
            margin-right: 8px;
        }

        .log-stats {
            margin-top: 15px;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

    </style>

</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <img src="static/InsuranceCo.png" alt="Logo" style="height: 2em; vertical-align: middle; margin-right: 12px;">
                Insurance Claim Fraud Detection
            </h1>
            <p>Intelligent fraud analysis powered by OpenAI GPT-4</p>
            <span class="badge">‚ú® Enhanced with Machine Learning</span>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="label">Total Claims Analyzed</div>
                <div class="value" id="totalClaims">0</div>
                <div class="subtext">All time</div>
            </div>
            <div class="stat-card high-risk">
                <div class="label">High Risk Claims</div>
                <div class="value" id="highRiskClaims">0</div>
                <div class="subtext" id="highRiskPercent">0% of total</div>
            </div>
            <div class="stat-card medium-risk">
                <div class="label">Medium Risk Claims</div>
                <div class="value" id="mediumRiskClaims">0</div>
                <div class="subtext" id="mediumRiskPercent">0% of total</div>
            </div>
            <div class="stat-card low-risk">
                <div class="label">Low Risk Claims</div>
                <div class="value" id="lowRiskClaims">0</div>
                <div class="subtext" id="lowRiskPercent">0% of total</div>
            </div>
        </div>

        <!-- Actions Panel -->
        <div class="actions-panel">
            <h3>üéØ Quick Actions</h3>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="toggleClaimForm()">üìù Analyze New Claim</button>
                <button class="btn btn-primary" onclick="loadFromDatabase()" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">üíæ Load from Database</button>
                <!--
                <button class="btn btn-success" onclick="generateTestData()">üé≤ Generate Test Data</button>
                -->
                <button class="btn btn-info" onclick="refreshDashboard()">üîÑ Refresh Dashboard</button>
                <button class="btn btn-danger" onclick="clearHistory()">üóëÔ∏è Clear History</button>
            </div>
        </div>

        <!-- Live Activity Log -->
        <div id="activityLog" class="activity-log">
            <div class="log-header">
                <h3>
                    <span>üìä Live Activity Log</span>
                    <span id="logBadge" style="font-size: 0.7em; background: #667eea; padding: 3px 8px; border-radius: 12px; margin-left: 10px;">0</span>
                </h3>
                <div class="log-controls">
                    <button class="btn-small" onclick="clearLog()">Clear</button>
                    <button class="btn-small" onclick="toggleActivityLog()">Hide</button>
                </div>
            </div>
            <div class="progress-bar-container" id="progressContainer" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;">0%</div>
                </div>
            </div>
            <div id="logContent" class="log-content"></div>
            <div class="log-stats">
                <span id="logStats">Ready to load claims...</span>
            </div>
        </div>

        <!-- Claim Form -->
        <div class="claim-form" id="claimForm">
            <h3>üìã Enter Claim Details</h3>
            <div class="form-grid">
                <div class="form-group">
                    <label>Claim ID</label>
                    <input type="text" id="claimId" value="CLM-2024-NEW" required>
                </div>
                <div class="form-group">
                    <label>Claim Type</label>
                    <select id="claimType">
                        <option>Auto Collision</option>
                        <option>Auto Theft</option>
                        <option>Property Damage</option>
                        <option>Personal Injury</option>
                        <option>Fire Damage</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Claim Amount ($)</label>
                    <input type="number" id="claimAmount" value="15000" required>
                </div>
                <div class="form-group">
                    <label>Policy Holder Name</label>
                    <input type="text" id="policyHolder" value="John Doe" required>
                </div>
                <div class="form-group">
                    <label>Policy Number</label>
                    <input type="text" id="policyNumber" value="POL-123456" required>
                </div>
                <div class="form-group">
                    <label>Incident Date</label>
                    <input type="date" id="incidentDate" required>
                </div>
                <div class="form-group">
                    <label>Filing Date</label>
                    <input type="date" id="filingDate" required>
                </div>
                <div class="form-group">
                    <label>Previous Claims Count</label>
                    <input type="number" id="previousClaims" value="0" min="0">
                </div>
                <div class="form-group">
                    <label>Incident Location</label>
                    <input type="text" id="incidentLocation" value="Los Angeles, CA">
                </div>
                <div class="form-group">
                    <label>Police Report Filed?</label>
                    <select id="policeReport">
                        <option>Yes</option>
                        <option>No</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Incident Description</label>
                <textarea id="incidentDescription" rows="3" placeholder="Describe the incident...">Rear-end collision at intersection</textarea>
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="analyzeClaim()">üîç Analyze Claim</button>
                <button class="btn" onclick="toggleClaimForm()" style="background: #95a5a6; color: white;">Cancel</button>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection"></div>

        <!-- Charts Section -->
        <div class="chart-section">
            <div class="chart-card">
                <h3>üìä Risk Distribution</h3>
                <canvas id="riskChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>üìà Fraud Score Trend</h3>
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <div class="chart-section">
            <div class="chart-card">
                <h3>üéØ Top Fraud Indicators</h3>
                <canvas id="indicatorChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>‚ö†Ô∏è High Risk Claims</h3>
                <div id="highRiskList" class="high-risk-claims">
                    <p style="color: #999;">No high-risk claims detected yet.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <div id="toastMessage"></div>
    </div>

    <script>
        let riskChart, trendChart, indicatorChart;

        // Initialize charts
        function initCharts() {
            // Risk Distribution Chart
            const riskCtx = document.getElementById('riskChart').getContext('2d');
            riskChart = new Chart(riskCtx, {
                type: 'doughnut',
                data: {
                    labels: ['High Risk', 'Medium Risk', 'Low Risk'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#e74c3c', '#f39c12', '#27ae60']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Trend Chart
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Average Fraud Score',
                        data: [],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // Indicator Chart
            const indicatorCtx = document.getElementById('indicatorChart').getContext('2d');
            indicatorChart = new Chart(indicatorCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Frequency',
                        data: [],
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Toggle claim form
        function toggleClaimForm() {
            const form = document.getElementById('claimForm');
            form.classList.toggle('active');
            
            // Set today's date as default
            if (form.classList.contains('active')) {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('incidentDate').value = today;
                document.getElementById('filingDate').value = today;
            }
        }

        // Show toast notification
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // Analyze claim
        async function analyzeClaim() {
            const claimData = {
                claim_id: document.getElementById('claimId').value,
                claim_type: document.getElementById('claimType').value,
                claim_amount: parseFloat(document.getElementById('claimAmount').value),
                incident_date: document.getElementById('incidentDate').value,
                filing_date: document.getElementById('filingDate').value,
                policy_holder: document.getElementById('policyHolder').value,
                policy_number: document.getElementById('policyNumber').value,
                previous_claims_count: parseInt(document.getElementById('previousClaims').value),
                incident_location: document.getElementById('incidentLocation').value,
                incident_description: document.getElementById('incidentDescription').value,
                police_report_filed: document.getElementById('policeReport').value,
                policy_start_date: '2023-01-01',
                years_as_customer: 1.5,
                witnesses: 'Unknown',
                days_since_policy_start: 365,
                filing_delay_days: 5,
                similar_claims_in_area: 2,
                repair_provider: 'Provider XYZ'
            };

            showToast('üîÑ Analyzing claim with AI...');

            try {
                const response = await fetch('/api/analyze-claim', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(claimData)
                });

                const result = await response.json();

                if (response.ok) {
                    displayResult(result);
                    toggleClaimForm();
                    refreshDashboard();
                    showToast('‚úÖ Analysis complete!');
                } else {
                    showToast('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                showToast('‚ùå Error analyzing claim');
                console.error(error);
            }
        }

        // Display analysis result
        function displayResult(result) {
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.add('active');

            const riskClass = result.risk_level.toLowerCase().replace('critical', 'high');
            const riskBadgeClass = result.risk_level.toLowerCase();

            const resultHTML = `
                <div class="result-card ${riskClass}">
                    <h3>Analysis Result: ${result.claim_id} 
                        <span class="risk-badge ${riskBadgeClass}">${result.risk_level}</span>
                    </h3>
                    <div style="margin: 20px 0;">
                        <strong>Fraud Score:</strong> ${result.fraud_score.toFixed(2)}/100<br>
                        <strong>Confidence:</strong> ${result.confidence.toFixed(2)}%<br>
                        <strong>Model:</strong> ${result.model_used}<br>
                        <strong>Anomaly Detection: </strong>${result.anomaly_label}<br>
                    </div>

                    ${result.reasoning && result.reasoning.length > 0 ? `
                        <div style="margin-top: 15px;">
                            <strong>üß† AI Reasoning:</strong>
                            <ul style="margin-left: 20px; margin-top: 10px;">
                                ${result.reasoning.map(action => `<li style="margin-bottom: 5px;">${action}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}

                    ${result.fraud_indicators && result.fraud_indicators.length > 0 ? `
                        <div style="margin-top: 15px;">
                            <strong>üö© Fraud Indicators:</strong>
                            <ul class="indicator-list">
                                ${result.fraud_indicators.map(ind => `<li>${ind}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    ${result.recommended_actions && result.recommended_actions.length > 0 ? `
                        <div style="margin-top: 15px;">
                            <strong>üí° Recommended Actions:</strong>
                            <ul style="margin-left: 20px; margin-top: 10px;">
                                ${result.recommended_actions.map(action => `<li style="margin-bottom: 5px;">${action}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;

            resultsSection.innerHTML = resultHTML + resultsSection.innerHTML;
        }

        // Generate test data
        async function generateTestData() {
            showToast('üé≤ Generating test claims...');

            try {
                const response = await fetch('/api/test-data/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ count: 5 })
                });

                const data = await response.json();

                if (response.ok) {
                    // Analyze each claim
                    for (const claim of data.claims) {
                        await fetch('/api/analyze-claim', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(claim)
                        });
                    }

                    refreshDashboard();
                    showToast('‚úÖ Generated and analyzed 5 test claims!');
                } else {
                    showToast('‚ùå Error generating test data');
                }
            } catch (error) {
                showToast('‚ùå Error generating test data');
                console.error(error);
            }
        }

        // Refresh dashboard
        async function refreshDashboard() {
            try {
                // Get summary
                const summaryResponse = await fetch('/api/insights/summary');
                if (!summaryResponse.ok) {
                    console.error('Summary endpoint returned:', summaryResponse.status);
                    return;
                }
                const summary = await summaryResponse.json();

                // Update stats
                document.getElementById('totalClaims').textContent = summary.total_claims_analyzed || 0;
                document.getElementById('highRiskClaims').textContent = summary.high_risk_count || 0;
                document.getElementById('mediumRiskClaims').textContent = summary.medium_risk_count || 0;
                document.getElementById('lowRiskClaims').textContent = summary.low_risk_count || 0;

                if (summary.total_claims_analyzed > 0) {
                    document.getElementById('highRiskPercent').textContent = 
                        `${summary.high_risk_percentage.toFixed(1)}% of total`;
                    document.getElementById('mediumRiskPercent').textContent = 
                        `${((summary.medium_risk_count / summary.total_claims_analyzed) * 100).toFixed(1)}% of total`;
                    document.getElementById('lowRiskPercent').textContent = 
                        `${((summary.low_risk_count / summary.total_claims_analyzed) * 100).toFixed(1)}% of total`;
                }

                // Update risk chart
                riskChart.data.datasets[0].data = [
                    summary.high_risk_count || 0,
                    summary.medium_risk_count || 0,
                    summary.low_risk_count || 0
                ];
                riskChart.update();

                // Get trends
                const trendsResponse = await fetch('/api/insights/trends');
                if (trendsResponse.ok) {
                    const trends = await trendsResponse.json();
                    if (trends.trends && trends.trends.length > 0) {
                        trendChart.data.labels = trends.trends.map(t => t.date);
                        trendChart.data.datasets[0].data = trends.trends.map(t => t.avg_fraud_score);
                        trendChart.update();
                    }
                }

                // Get top indicators
                const indicatorsResponse = await fetch('/api/insights/top-indicators');
                if (indicatorsResponse.ok) {
                    const indicators = await indicatorsResponse.json();
                    if (indicators.top_indicators && indicators.top_indicators.length > 0) {
                        const topTen = indicators.top_indicators.slice(0, 10);
                        indicatorChart.data.labels = topTen.map(i => i.indicator);
                        indicatorChart.data.datasets[0].data = topTen.map(i => i.count);
                        indicatorChart.update();
                    }
                }

                // Get high risk claims
                const highRiskResponse = await fetch('/api/insights/high-risk-claims');
                if (highRiskResponse.ok) {
                    const highRisk = await highRiskResponse.json();
                    const highRiskList = document.getElementById('highRiskList');
                    if (highRisk.claims && highRisk.claims.length > 0) {
                        highRiskList.innerHTML = highRisk.claims.slice(0, 5).map(claim => `
                            <div class="high-risk-claim-item">
                                <strong>${claim.claim_id}</strong> - Score: ${claim.fraud_score.toFixed(2)}<br>
                                <small>${claim.reasoning ? claim.reasoning.substring(0, 100) + '...' : ''}</small>
                            </div>
                        `).join('');
                    } else {
                        highRiskList.innerHTML = '<p style="color: #999;">No high-risk claims detected yet.</p>';
                    }
                }

            } catch (error) {
                console.error('Error refreshing dashboard:', error);
                // Don't show error to user, just log it
            }
        }

        // Clear history
        async function clearHistory() {
            if (confirm('Are you sure you want to clear all analysis history?')) {
                try {
                    await fetch('/api/history/clear', { method: 'POST' });
                    document.getElementById('resultsSection').innerHTML = '';
                    document.getElementById('resultsSection').classList.remove('active');
                    refreshDashboard();
                    showToast('‚úÖ History cleared!');
                } catch (error) {
                    showToast('‚ùå Error clearing history');
                    console.error(error);
                }
            }
        }
        // Load claims from database
        async function loadFromDatabase() {
            // Initialize activity log
            clearLog();
            addLog('üîå Initiating database connection...', 'info');
            showToast('üíæ Connecting to VIBECODING_MEDIUM database...');
            updateLogStats('Connecting to database...');
            
            try {
                // Connect to database
                addLog('üì° Connecting to VIBECODING_MEDIUM...', 'info');
                const connectResponse = await fetch('/api/database/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!connectResponse.ok) {
                    addLog('‚ùå Database connection failed', 'error');
                    throw new Error('Failed to connect to database');
                }
                
                const connectData = await connectResponse.json();
                addLog(`‚úÖ Connected successfully to ${connectData.connection || 'VIBECODING_MEDIUM'}`, 'success');
                if (connectData.available_tables) {
                    addLog(`üìã Found ${connectData.available_tables.length} claim tables`, 'info');
                }
                
                showToast('üîÑ Loading claims from database...');
                addLog('üì• Loading claims data...', 'info');
                updateLogStats('Loading claims...');
                
                // Try progressive endpoint first
                const useProgressive = true;
                
                if (useProgressive) {
                    await loadWithProgressiveUpdates();
                } else {
                    await loadWithLegacyMethod();
                }
                
            } catch (error) {
                console.error('Database error:', error);
                addLog(`‚ùå Error: ${error.message}`, 'error');
                showToast('‚ùå Error loading from database: ' + error.message);
                updateLogStats('Error occurred');
            }
        }
        
        async function loadWithProgressiveUpdates() {
            try {
                const response = await fetch('/api/database/load-claims-progressive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        table_name: 'CLAIMS',
                        limit: 20,
                        auto_analyze: true
                    })
                });
                
                if (!response.ok) {
                    addLog('‚ö†Ô∏è  Progressive endpoint not available, using legacy method...', 'warning');
                    return await loadWithLegacyMethod();
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, {stream: true});
                    const lines = buffer.split('\n');
                    buffer = lines.pop();
                    
                    for (const line of lines) {
                        if (line.trim() && line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                handleProgressUpdate(data);
                            } catch (e) {
                                console.error('Parse error:', e);
                            }
                        }
                    }
                }
                
            } catch (error) {
                addLog(`‚ö†Ô∏è  Progressive loading failed: ${error.message}`, 'warning');
                addLog('üìã Falling back to legacy method...', 'info');
                return await loadWithLegacyMethod();
            }
        }
        
        async function loadWithLegacyMethod() {
            try {
                addLog('üìã Using standard loading method...', 'info');
                
                const loadResponse = await fetch('/api/database/load-claims', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        table_name: 'CLAIMS',
                        limit: 20,
                        auto_analyze: true
                    })
                });
                
                const result = await loadResponse.json();
                
                if (loadResponse.ok) {
                    addLog(`‚úÖ Loaded ${result.claims_loaded} claims from database`, 'success');
                    addLog(`üîç Analyzing ${result.claims_loaded} claims...`, 'info');
                    
                    showToast(`‚úÖ Loaded ${result.claims_loaded} claims! Analyzing...`);
                    updateLogStats(`Loaded ${result.claims_loaded} claims, analyzing...`);
                    
                    // Simulate progress
                    if (result.claims_analyzed) {
                        for (let i = 1; i <= result.claims_analyzed; i++) {
                            updateProgress(i, result.claims_analyzed);
                            await new Promise(resolve => setTimeout(resolve, 50));
                        }
                    }
                    
                    addLog(`‚úÖ Analysis complete: ${result.claims_analyzed} claims processed`, 'success');
                    if (result.high_risk_count) {
                        addLog(`üö® High risk claims detected: ${result.high_risk_count}`, 'high-risk');
                    }
                    
                    // Display results
                    if (result.analyses && result.analyses.length > 0) {
                        result.analyses.forEach(analysis => {
                            displayResult(analysis);
                        });
                    }
                    
                    // Refresh dashboard
                    hideProgress();
                    updateLogStats(`‚úÖ Complete: ${result.claims_analyzed} claims analyzed, ${result.high_risk_count || 0} high risk`);
                    
                    setTimeout(() => {
                        refreshDashboard();
                        showToast(`üéâ Analysis complete! ${result.claims_analyzed} claims analyzed.`);
                    }, 1000);
                    
                } else {
                    throw new Error(result.error || 'Failed to load claims');
                }
                
            } catch (error) {
                addLog(`‚ùå Loading failed: ${error.message}`, 'error');
                throw error;
            }
        }
        
        function handleProgressUpdate(data) {
            if (data.type === 'connecting') {
                addLog('üîå ' + data.message, 'info');
            } else if (data.type === 'connected') {
                addLog('‚úÖ ' + data.message, 'success');
            } else if (data.type === 'loading') {
                addLog('üì• ' + data.message, 'info');
            } else if (data.type === 'loaded') {
                addLog(`‚úÖ Loaded ${data.count} claims from database`, 'success');
            } else if (data.type === 'claim_loaded') {
                if (data.current % 5 === 0 || data.current === data.total) {
                    addLog(`üìÑ Loading progress: ${data.current}/${data.total} claims`, 'info');
                }
            } else if (data.type === 'claim_analyzing') {
                addLog(`üîç Analyzing: ${data.claim_id} (${data.current}/${data.total})`, 'info');
                updateProgress(data.current, data.total);
            } else if (data.type === 'claim_analyzed') {
                const riskEmoji = data.risk_level === 'HIGH' || data.risk_level === 'CRITICAL' ? 'üö®' : 
                                 data.risk_level === 'MEDIUM' ? '‚ö†Ô∏è' : '‚úÖ';
                const logType = data.risk_level === 'HIGH' || data.risk_level === 'CRITICAL' ? 'high-risk' :
                               data.risk_level === 'MEDIUM' ? 'warning' : 'success';
                               
                addLog(`${riskEmoji} ${data.claim_id}: ${data.risk_level} RISK (Score: ${data.fraud_score?.toFixed(2) || 'N/A'})`, logType);
                updateProgress(data.current, data.total);
                
                // Display result immediately
                if (data.analysis) {
                    displayResult(data.analysis);
                }
            } else if (data.type === 'complete') {
                hideProgress();
                addLog(`‚úÖ All ${data.total_analyzed} claims analyzed!`, 'success');
                addLog(`üìä High Risk: ${data.high_risk_count}, Medium: ${data.medium_risk_count}, Low: ${data.low_risk_count}`, 'info');
                updateLogStats(`‚úÖ Complete: ${data.total_analyzed} analyzed, ${data.high_risk_count} high risk`);
                
                // Auto-refresh dashboard
                setTimeout(() => {
                    refreshDashboard();
                    showToast(`üéâ Complete! ${data.total_analyzed} claims analyzed.`);
                }, 500);
            } else if (data.type === 'error') {
                addLog(`‚ùå Error: ${data.message}`, 'error');
            }
        }

        // ============================================
        // Activity Log Functions
        // ============================================
        let logEntryCount = 0;
        
        function addLog(message, type = 'info') {
            const logContent = document.getElementById('logContent');
            const activityLog = document.getElementById('activityLog');
            const logBadge = document.getElementById('logBadge');
            
            // Show log if hidden
            activityLog.classList.add('active');
            
            // Create log entry
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span>${message}`;
            
            logContent.appendChild(entry);
            logContent.scrollTop = logContent.scrollHeight;
            
            logEntryCount++;
            logBadge.textContent = logEntryCount;
        }
        
        function clearLog() {
            document.getElementById('logContent').innerHTML = '';
            document.getElementById('logStats').textContent = 'Log cleared';
            document.getElementById('logBadge').textContent = '0';
            logEntryCount = 0;
            hideProgress();
        }
        
        function toggleActivityLog() {
            const log = document.getElementById('activityLog');
            log.classList.toggle('active');
        }
        
        function updateProgress(current, total) {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            
            progressContainer.style.display = 'block';
            const percent = Math.round((current / total) * 100);
            progressFill.style.width = percent + '%';
            progressFill.textContent = `${current}/${total} (${percent}%)`;
        }
        
        function hideProgress() {
            const progressContainer = document.getElementById('progressContainer');
            if (progressContainer) {
                progressContainer.style.display = 'none';
            }
        }
        
        function updateLogStats(stats) {
            document.getElementById('logStats').textContent = stats;
        }

        function batchFromDatabase() {
            addLog('function call success', 'info');
        }


        // ============================================
        // End Activity Log Functions
        // ============================================

        // Initialize on page load
        window.addEventListener('load', () => {
            initCharts();
            refreshDashboard();
        });
    </script>
</body>
</html>